<Grid x:Class="XMapView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:WPFZ80MapEditor"
      xmlns:converters="clr-namespace:WPFZ80MapEditor.ValueConverters"
             mc:Ignorable="d" 
             x:Name="MapView"
             d:DesignHeight="300" d:DesignWidth="300" Width="256" Height="256" SnapsToDevicePixels="True" Background="DarkGray">
    <Grid.Resources>
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
        <converters:TileConverter x:Key="TileConverter"/>
        <converters:CollisionConverter x:Key="CollisionConverter"/>
        <DataTemplate x:Key="TileTemplate">
            <Control MouseLeftButtonUp="TileButton_Click" MouseEnter="TileGrid_MouseEnter" MouseLeave="TileGrid_MouseLeave">
                <Control.Template>
                    <ControlTemplate>
                        <Grid x:Name="TileGrid" Width="16" Height="16" Background="Transparent">
                            <VisualStateManager.VisualStateGroups>
                                <VisualStateGroup>
                                    <VisualStateGroup.Transitions>
                                        <!--<VisualTransition From="MouseOver" GeneratedDuration="0:0:0.125"/>-->
                                        <VisualTransition From="MouseOver" GeneratedDuration="0"/>
                                        <VisualTransition To="MouseOver" GeneratedDuration="0"/>
                                    </VisualStateGroup.Transitions>
                                    <VisualState x:Name="Normal"/>
                                    <VisualState x:Name="MouseOver">
                                        <Storyboard>
                                            <DoubleAnimationUsingKeyFrames Storyboard.TargetProperty="(UIElement.Opacity)" Storyboard.TargetName="TileOverlay">
                                                <EasingDoubleKeyFrame KeyTime="0" Value="0.3"/>
                                            </DoubleAnimationUsingKeyFrames>
                                        </Storyboard>
                                    </VisualState>
                                </VisualStateGroup>
                            </VisualStateManager.VisualStateGroups>
                            <!--<Rectangle Name="CollisionOverlay" Fill="Red" Opacity="0.25"
                               Panel.ZIndex="2" IsHitTestVisible="False" Width="16" Height="16" Visibility="{Binding ., Converter={StaticResource CollisionConverter}}"/>-->
                            <Rectangle x:Name="TileOverlay" Fill="White" Panel.ZIndex="1" Opacity="0" IsHitTestVisible="False"  Width="16" Height="16"/>
                            <Image x:Name="TileImage" Panel.ZIndex="0" IsHitTestVisible="False" Width="16" Height="16">
                                <Image.Source>
                                    <MultiBinding Converter="{StaticResource TileConverter}">
                                        <Binding ElementName="MapView" Path="DataContext.Tileset"/>
                                        <Binding Path="."/>
                                    </MultiBinding>
                                </Image.Source>
                            </Image>
                        </Grid>
                    </ControlTemplate>
                </Control.Template>
            </Control>
        </DataTemplate>
    </Grid.Resources>

    <TextBlock>NEW MAP</TextBlock>

    <ItemsControl ItemsSource="{Binding TileData}" Margin="0" ItemTemplate="{StaticResource TileTemplate}"
                  Visibility="{Binding Exists, Converter={StaticResource BooleanToVisibilityConverter}}">        
        <ItemsControl.ItemsPanel>
            <ItemsPanelTemplate>
                <WrapPanel x:Name="TilePanel" Orientation="Horizontal">
                </WrapPanel>
            </ItemsPanelTemplate>
        </ItemsControl.ItemsPanel>
    </ItemsControl>
</Grid>
